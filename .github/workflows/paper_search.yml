name: Daily Paper Fetch

permissions:
  contents: write

on:
  # ÊØèÂ§© UTC 5:00 = Êñ∞Âä†Âù°‰∏ãÂçà 1:00
  schedule:
    - cron: "0 5 * * *"
  workflow_dispatch:

jobs:
  fetch-papers:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout main
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main

      # 2. Reset workspace to remote main (Èò≤Ê≠¢ÂàÜÂèâ)
      - name: Reset workspace
        run: |
          git fetch origin main
          git reset --hard origin/main
          git clean -fd

      # 3. Setup Python
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # 4. Install deps
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      # 5. Run fetch papers
      - name: Fetch AI papers
        run: |
          mkdir -p results
          python fetch_papers.py --from-date 2025-06-01

      # 6. Build dashboards
      - name: Build paper dashboards
        run: |
          for json in results/stanford_ai_papers_*.json; do
            echo "üìÑ Building dashboard for $json"
            python build_html_dashboard.py --in-json "$json"
          done

      # 7. Cleanup old files (>30 days)
      - name: Cleanup > 30 days
        run: |
          find results -type f -name "*.json" -mtime +30 -print -delete || true
          find results -type f -name "*.html" -mtime +30 -print -delete || true

      # 8. Keep newest 40 (papers grow slower than jobs)
      - name: Keep newest 40
        run: |
          ls -t results/*.json | tail -n +41 | xargs -r rm
          ls -t results/*.html | tail -n +41 | xargs -r rm

      # 9. Commit & push to data-history
      - name: Push paper results to data-history
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git fetch origin data-history || true
          if git branch -r | grep -q "origin/data-history"; then
            git checkout -B data-history origin/data-history
          else
            git checkout -B data-history
          fi

          git add results
          if git diff --cached --quiet; then
            echo "üìé No paper changes."
          else
            git commit -m "Daily AI paper fetch + dashboards"
            git push origin data-history --force-with-lease
          fi
      # 10. Commit & push Âà∞ data-historyÔºàÈ°∫‰æøÁîüÊàêÈ¶ñÈ°µ index.htmlÔºâ
      - name: Commit, build index, and push to data-history
        run: |
          # ÈÖçÁΩÆ git Áî®Êà∑
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          # ÊääËøúÁ´Ø data-history Êãâ‰∏ãÊù•ÔºàÂ¶ÇÊûúÊúâÔºâ
          git fetch origin data-history || true
          if git branch -r | grep -q "origin/data-history"; then
            git checkout -B data-history origin/data-history
          else
            git checkout -B data-history
          fi

          # --- ÁîüÊàêÈ¶ñÈ°µ index.html ---
          mkdir -p results

          # ÊúÄÊñ∞ job / paper ÁöÑ HTML
          latest_job=$(ls -t results/job_results_*.html 2>/dev/null | head -n 1 || true)
          latest_paper=$(ls -t results/stanford_ai_papers_openalex_*.html 2>/dev/null | head -n 1 || true)

          # ÊâÄÊúâ HTMLÔºàÊåâÊó∂Èó¥ÂÄíÂ∫èÔºâ
          all_html=$(ls -t results/*.html 2>/dev/null || true)

          # Âú®‰ªìÂ∫ìÊ†πÁõÆÂΩïÁîüÊàê index.htmlÔºàËÆøÈóÆ https://xxx.github.io/git-test/ Â∞±ËÉΩÁúãÂà∞Ôºâ
          {
            echo '<!DOCTYPE html>'
            echo '<html lang="en">'
            echo '<head>'
            echo '  <meta charset="UTF-8" />'
            echo '  <title>Daily Dashboards</title>'
            echo '  <meta name="viewport" content="width=device-width, initial-scale=1" />'
            echo '  <style>'
            echo '    body { font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;'
            echo '           max-width: 960px; margin: 2rem auto; padding: 0 1rem; }'
            echo '    h1 { font-size: 1.9rem; margin-bottom: 0.5rem; }'
            echo '    h2 { margin-top: 2rem; font-size: 1.4rem; }'
            echo '    ul { line-height: 1.6; }'
            echo '    .section { margin-bottom: 1.5rem; }'
            echo '    .tag { font-size: 0.8rem; padding: 2px 6px; border-radius: 999px; background: #eef; margin-left: 4px; }'
            echo '    a { text-decoration: none; color: #0366d6; }'
            echo '    a:hover { text-decoration: underline; }'
            echo '  </style>'
            echo '</head>'
            echo '<body>'
            echo '  <h1>Daily Dashboards</h1>'
            echo '  <p>This page is auto-generated by GitHub Actions from the <code>data-history</code> branch.</p>'

            echo '  <div class="section">'
            echo '    <h2>Latest</h2>'
            echo '    <ul>'
            if [ -n "$latest_job" ]; then
              lj=$(basename "$latest_job")
              echo "      <li>Latest job search <span class=\"tag\">jobs</span>: <a href=\"results/$lj\">$lj</a></li>"
            fi
            if [ -n "$latest_paper" ]; then
              lp=$(basename "$latest_paper")
              echo "      <li>Latest Stanford AI papers <span class=\"tag\">papers</span>: <a href=\"results/$lp\">$lp</a></li>"
            fi
            echo '    </ul>'
            echo '  </div>'

            echo '  <div class="section">'
            echo '    <h2>All dashboards</h2>'
            echo '    <ul>'
            for f in $all_html; do
              name=$(basename "$f")
              label="$name"
              if echo "$name" | grep -q '^job_results_'; then
                echo "      <li><a href=\"results/$name\">$label</a> <span class=\"tag\">jobs</span></li>"
              elif echo "$name" | grep -q '^stanford_ai_papers_openalex_'; then
                echo "      <li><a href=\"results/$name\">$label</a> <span class=\"tag\">papers</span></li>"
              else
                echo "      <li><a href=\"results/$name\">$label</a></li>"
              fi
            done
            echo '    </ul>'
            echo '  </div>'

            echo '</body>'
            echo '</html>'
          } > index.html

          # Êèê‰∫§ results/ Âíå index.html
          git add results index.html || true

          if git diff --cached --quiet; then
            echo "No changes to commit."
          else
            git commit -m "Daily dashboards + index"
            git push origin data-history --force-with-lease
          fi
