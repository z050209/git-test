name: Daily Job Search

permissions:
  contents: write

on:
  schedule:
    - cron: "0 4 * * *"    # 每天 UTC 4:00 = 新加坡中午 12:00
  workflow_dispatch:        # 手动触发

jobs:
  run-job-search:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout main
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main

      # 2. Reset local HEAD to remote main
      - name: Reset local to remote main
        run: |
          git fetch origin main
          git reset --hard origin/main
          git clean -fd

      # 3. Setup Python
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # 4. Install deps
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      # 5. Run job crawler
      - name: Run job crawler
        run: python run.py

      # 6. Collect results
      - name: Collect results
        run: |
          mkdir -p results
          find . -maxdepth 2 -type f -name "job_results_*.json" -exec mv {} results/ \;

      # 7. Generate dashboards
      - name: Generate dashboards
        run: |
          for f in results/job_results_*.json; do
            echo "➡️ Building html for $f"
            python build_jobs_dashboard.py --in-json "$f"
          done

      # 8. Remove old files (>30 days)
      - name: Cleanup > 30 days
        run: |
          find results -type f -name "job_results_*.json" -mtime +30 -print -delete || true
          find results -type f -name "job_results_*.html" -mtime +30 -print -delete || true

      # 9. Keep only newest 30
      - name: Cleanup newest 30
        run: |
          ls -t results/job_results_*.json | tail -n +31 | xargs -r rm
          ls -t results/job_results_*.html | tail -n +31 | xargs -r rm

      # 10. Commit & push 到 data-history（自己用 git，不用第三方 action）
      - name: Commit and push to data-history
        run: |
          # 配置 git 用户
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          # 把远端 data-history 拉下来（如果有）
          git fetch origin data-history || true
          if git branch -r | grep -q "origin/data-history"; then
            git checkout -B data-history origin/data-history
          else
            git checkout -B data-history
          fi

          # 确认 results 存在
          ls -R
          git add results || true

          if git diff --cached --quiet; then
            echo "No changes to commit."
          else
            git commit -m "Daily job scraping + dashboards"
            git push origin data-history --force-with-lease
          fi
      # 10. Commit & push 到 data-history（顺便生成首页 index.html）
      - name: Commit, build index, and push to data-history
        run: |
          # 配置 git 用户
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          # 把远端 data-history 拉下来（如果有）
          git fetch origin data-history || true
          if git branch -r | grep -q "origin/data-history"; then
            git checkout -B data-history origin/data-history
          else
            git checkout -B data-history
          fi

          # --- 生成首页 index.html ---
          mkdir -p results

          # 最新 job / paper 的 HTML
          latest_job=$(ls -t results/job_results_*.html 2>/dev/null | head -n 1 || true)
          latest_paper=$(ls -t results/stanford_ai_papers_openalex_*.html 2>/dev/null | head -n 1 || true)

          # 所有 HTML（按时间倒序）
          all_html=$(ls -t results/*.html 2>/dev/null || true)

          # 在仓库根目录生成 index.html（访问 https://xxx.github.io/git-test/ 就能看到）
          {
            echo '<!DOCTYPE html>'
            echo '<html lang="en">'
            echo '<head>'
            echo '  <meta charset="UTF-8" />'
            echo '  <title>Daily Dashboards</title>'
            echo '  <meta name="viewport" content="width=device-width, initial-scale=1" />'
            echo '  <style>'
            echo '    body { font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;'
            echo '           max-width: 960px; margin: 2rem auto; padding: 0 1rem; }'
            echo '    h1 { font-size: 1.9rem; margin-bottom: 0.5rem; }'
            echo '    h2 { margin-top: 2rem; font-size: 1.4rem; }'
            echo '    ul { line-height: 1.6; }'
            echo '    .section { margin-bottom: 1.5rem; }'
            echo '    .tag { font-size: 0.8rem; padding: 2px 6px; border-radius: 999px; background: #eef; margin-left: 4px; }'
            echo '    a { text-decoration: none; color: #0366d6; }'
            echo '    a:hover { text-decoration: underline; }'
            echo '  </style>'
            echo '</head>'
            echo '<body>'
            echo '  <h1>Daily Dashboards</h1>'
            echo '  <p>This page is auto-generated by GitHub Actions from the <code>data-history</code> branch.</p>'

            echo '  <div class="section">'
            echo '    <h2>Latest</h2>'
            echo '    <ul>'
            if [ -n "$latest_job" ]; then
              lj=$(basename "$latest_job")
              echo "      <li>Latest job search <span class=\"tag\">jobs</span>: <a href=\"results/$lj\">$lj</a></li>"
            fi
            if [ -n "$latest_paper" ]; then
              lp=$(basename "$latest_paper")
              echo "      <li>Latest Stanford AI papers <span class=\"tag\">papers</span>: <a href=\"results/$lp\">$lp</a></li>"
            fi
            echo '    </ul>'
            echo '  </div>'

            echo '  <div class="section">'
            echo '    <h2>All dashboards</h2>'
            echo '    <ul>'
            for f in $all_html; do
              name=$(basename "$f")
              label="$name"
              if echo "$name" | grep -q '^job_results_'; then
                echo "      <li><a href=\"results/$name\">$label</a> <span class=\"tag\">jobs</span></li>"
              elif echo "$name" | grep -q '^stanford_ai_papers_openalex_'; then
                echo "      <li><a href=\"results/$name\">$label</a> <span class=\"tag\">papers</span></li>"
              else
                echo "      <li><a href=\"results/$name\">$label</a></li>"
              fi
            done
            echo '    </ul>'
            echo '  </div>'

            echo '</body>'
            echo '</html>'
          } > index.html

          # 提交 results/ 和 index.html
          git add results index.html || true

          if git diff --cached --quiet; then
            echo "No changes to commit."
          else
            git commit -m "Daily dashboards + index"
            git push origin data-history --force-with-lease
          fi
